name: Deploy to Hetzner

on:
  push:
    branches:
      - production
  workflow_dispatch: # Allow manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.HETZNER_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.HETZNER_HOST }} >> ~/.ssh/known_hosts

      - name: Create env file
        run: |
          cat > /tmp/.env << 'ENVFILE'
          NODE_ENV=production
          HOST=127.0.0.1
          PORT=5000
          DB_USER=postgres
          DB_HOST=localhost
          DB_NAME=tienhock_prod
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_PORT=5432
          REACT_APP_API_BASE_URL=https://api.tienhock.com
          MYINVOIS_API_BASE_URL=https://api.myinvois.hasil.gov.my
          MYINVOIS_CLIENT_ID=${{ secrets.MYINVOIS_CLIENT_ID }}
          MYINVOIS_CLIENT_SECRET=${{ secrets.MYINVOIS_CLIENT_SECRET }}
          MYINVOIS_GT_CLIENT_ID=0233a712-c010-4b4f-afba-9c266076ab50
          MYINVOIS_GT_CLIENT_SECRET=59f50d71-0b60-42c7-a371-0708fc08c27d
          MYINVOIS_JP_CLIENT_ID=12bc3955-80f4-4478-a90e-dec05c771824
          MYINVOIS_JP_CLIENT_SECRET=9106918b-62ec-411a-adc9-34f8990f3f48
          AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION=${{ secrets.AWS_REGION }}
          S3_BUCKET_NAME=${{ secrets.S3_BUCKET_NAME }}
          ENVFILE

      - name: Deploy to Hetzner
        run: |
          # Copy env file to server
          scp -i ~/.ssh/deploy_key /tmp/.env ${{ secrets.HETZNER_USERNAME }}@${{ secrets.HETZNER_HOST }}:~/tienhock-app/.env

          ssh -i ~/.ssh/deploy_key ${{ secrets.HETZNER_USERNAME }}@${{ secrets.HETZNER_HOST }} << 'EOF'
            cd ~/tienhock-app

            # Stash any local changes (package-lock.json, etc.) to prevent pull conflicts
            git stash --include-untracked

            # Pull latest changes
            git checkout production
            git pull origin production

            # Install dependencies
            npm install --legacy-peer-deps

            # Build frontend
            NODE_OPTIONS="--max-old-space-size=4096" npm run build

            # Restart application with PM2
            pm2 restart tienhock-server || pm2 start ecosystem.config.cjs

            # Show status
            pm2 status
          EOF
